---
import Layout from "../layouts/Layout.astro";
import GothicButton from "../components/GothicButton.astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";

// Get all products from Content Collections
const allProducts = await getCollection('products');

// Calculate category and collection counts
const categoryCounts: Record<string, number> = allProducts.reduce((acc: Record<string, number>, product) => {
  const category = product.data.type;
  acc[category] = (acc[category] || 0) + 1;
  return acc;
}, {});


// Get unique categories
const categories = [...new Set(allProducts.map((p) => p.data.type))];

// SEO metadata
const title = "Dot For You - Handmade Clothing Collection";
const description = "Handmade pants and clothing from Poland. Available in various sizes and collections.";
---

<Layout title={title} description={description} backgroundVideoFilter="brightness(0.7)">
  <div class="shop-container" transition:animate="fade">
    <!-- Hero Section -->
    <section class="shop-hero">
      <section class="filters-section">
        <div class="filters-container flow flow-space-l wrapper">
          <div class="flow flow-space-xs">
            <div class="filter-group">
              <span class="filter-label">Dostępność:</span>
              <div class="filter-buttons">
                <GothicButton
                  variant="button4"
                  size="medium"
                  class="filter-btn active"
                  data-filter="all"
                >
                  Wszystkie ({allProducts.length})
                </GothicButton>
                <GothicButton
                  variant="button4"
                  size="medium"
                  class="filter-btn"
                  data-filter="available"
                >
                  Dostępne ({
                    allProducts.filter((p) => p.data.status === "Available").length
                  })
                </GothicButton>
                <GothicButton
                  variant="button4"
                  size="medium"
                  class="filter-btn"
                  data-filter="unavailable"
                >
                  Niedostępne ({
                    allProducts.filter((p) => p.data.status === "Unavailable").length
                  })
                </GothicButton>
              </div>
            </div>

            <div class="filter-group">
              <span class="filter-label">Kategoria:</span>
              <div class="filter-buttons">
                <GothicButton
                  variant="button4"
                  size="medium"
                  class="category-btn active"
                  data-category="all"
                >
                  Wszystkie ({allProducts.length})
                </GothicButton>
                {
                  categories.map((category) => (
                    <GothicButton
                      variant="button4"
                      size="medium"
                      class="category-btn"
                      data-category={category}
                    >
                      {category === "pants"
                        ? "Spodnie"
                        : category === "hoodies"
                          ? "Bluzy"
                          : category === "accessories"
                            ? "Akcesoria"
                            : category}
                      ({categoryCounts[category] || 0})
                    </GothicButton>
                  ))
                }
              </div>
            </div>
          </div>
          <section class="products-section">
            <div class="shop__products-grid grid" transition:animate="fade">
              {
                allProducts.map((product, index) => {
                  const isAvailable = product.data.status === "Available";

                  // Eagerly load first 6 products (above the fold), lazy load the rest
                  const loadingStrategy = index < 6 ? "eager" : "lazy";

                  // Get first image for the product
                  const hasImage = product.data.images.length > 0;

                  return (
                    <article
                      class="shop_.shop__product-card"
                      data-status={product.data.status}
                      data-category={product.data.type}
                      data-collection={product.data.collection}
                      data-available={isAvailable ? "true" : "false"}
                    >
                      <a
                        href={`/shop/${product.slug}`}
                        class="product-link flow"
                      >
                        <div class="shop__product-image-container">
                          {hasImage ? (
                            <Image
                              src={`/images/${product.data.images[0]}`}
                              alt={product.data.product_name}
                              width={400}
                              height={400}
                              loading={loadingStrategy}
                              class="shop__product-image" transition:name={`product-image-${product.slug}`}
                            />
                          ) : (
                            <Image
                              src="/images/placeholder.webp"
                              alt="Image Not Available"
                              width={400}
                              height={400}
                              loading="lazy"
                              class="shop__product-image" transition:name={`product-image-${product.slug}`}
                            />
                          )}
                          {!isAvailable && (
                            <div class="shop__product-overlay">
                              {/* <span class="shop__overlay-text">NIEDOSTĘPNE</span> */}
                            </div>
                          )}
                        </div>
                        <div class="shop__product-info">
                          <h3 class="shop__product-name">{product.data.product_name}</h3>
                          <div class="shop__product-meta">
                            {/* <span class="shop__product-collection">{product.data.collection}</span> */}
                            <span class="shop__product-price">
                              {product.data.price_pln} ZŁ
                            </span>
                          </div>
                          <div class="shop__product-details">
                            <span class="shop__product-size">Rozmiar: {product.data.size_eu}</span>
                          </div>
                        </div>
                      </a>
                    </article>
                  );
                })
              }
            </div>

            <div class="no-results" style="display: none;">
              <p>Nie znaleziono produktów spełniających kryteria.</p>
            </div>
          </section>
        </div>

        <!-- Filters Section -->
      </section>
    </section>
  </div>
</Layout>

<style>
  
  .shop-hero {
    position: relative;
    min-height: 100vh;
  }

  .shop__product-image-container img {
    height: 100%;
  }

  .shop-container {
    min-height: 100vh;
    color: var(--color-highlight-bone);
  }

  .products-section {
    z-index: 999;
  }

  .hero-content {
    position: relative;
    z-index: 2;
    text-align: center;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
  }

  .hero-title {
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 4px;
  }

  .filters-section {
    z-index: 10;
    padding: var(--space-m);
    position: relative;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    align-items: center;
  }

  .filter-label {
    font-size: var(--size-step-00);
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .filter-buttons,
  .category-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
  }

  /* Active state styling for Gothic buttons */
  .filter-btn.active,
  .category-btn.active {
    opacity: 1;
  }


  @media (max-width: 640px) {
  }

  /* Product Card */
  .shop__product-card {
    position: relative;
    transition:
      transform 0.3s,
      box-shadow 0.3s;
  }

  .shop__products-grid {
    --grid-min-item-size: 8rem;
  }

  .shop__product-card.hidden {
    display: none;
  }

  .shop__product-card:hover {
    transform: translateY(-4px);
  }

  .product-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .product-image-container {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 8px;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
  }

  .product-info {
    --flow-space: var(--space-2xs);
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: center;
    text-align: center;
  }

  .product-meta {
    display: flex;
    flex-direction: column;
  }

  .product-name {
    font-size: 1.2rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .product-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .product-category {
    font-size: 0.8rem;
    color: var(--color-metal-bronze-patina);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .product-price {
    font-size: 1.1rem;
    font-weight: bold;
  }
</style>

<script>
  function initializeShopFilters() {
    console.log("Shop page loaded with filters");

    // Get all product cards
    const productCards = document.querySelectorAll(
      ".shop__product-card"
    ) as NodeListOf<HTMLElement>;
    const noResultsMessage = document.querySelector(
      ".no-results"
    ) as HTMLElement;

    // Filter state
    let currentAvailabilityFilter = "all";
    let currentCategoryFilter = "all";

    // Filter buttons
    const filterBtns = document.querySelectorAll(
      ".filter-btn"
    ) as NodeListOf<HTMLButtonElement>;
    const categoryBtns = document.querySelectorAll(
      ".category-btn"
    ) as NodeListOf<HTMLButtonElement>;

    // Apply filters function
    function applyFilters() {
      let visibleCount = 0;

      productCards.forEach((card) => {
        const cardStatus = card.getAttribute("data-status");
        const cardCategory = card.getAttribute("data-category");
        const cardAvailable = card.getAttribute("data-available") === "true";

        let showCard = true;

        // Availability filter
        if (currentAvailabilityFilter === "available" && !cardAvailable) {
          showCard = false;
        } else if (
          currentAvailabilityFilter === "unavailable" &&
          cardAvailable
        ) {
          showCard = false;
        }

        // Category filter
        if (
          currentCategoryFilter !== "all" &&
          cardCategory !== currentCategoryFilter
        ) {
          showCard = false;
        }

        if (showCard) {
          card.classList.remove("hidden");
          visibleCount++;
        } else {
          card.classList.add("hidden");
        }
      });

      if (noResultsMessage) {
        noResultsMessage.style.display = visibleCount === 0 ? "block" : "none";
      }
    }

    filterBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        filterBtns.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentAvailabilityFilter = btn.getAttribute("data-filter") || "all";
        applyFilters();
      });
    });

    categoryBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        categoryBtns.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentCategoryFilter = btn.getAttribute("data-category") || "all";
        applyFilters();
      });
    });

    console.log("Filters initialized with", productCards.length, "products");
  }

  document.addEventListener("DOMContentLoaded", initializeShopFilters);

  document.addEventListener("astro:page-load", initializeShopFilters);
</script>
